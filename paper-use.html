<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Solana QR Tool</title>

<script src="./solana-web3.iife.min.js"></script>
<script src="./html5-qrcode.min.js"></script>

<style>
body {
  font-family: monospace;
  padding: 20px;
  max-width: 600px;
}
input, select, button {
  width: 100%;
  margin-top: 6px;
  padding: 6px;
}
pre {
  background: #f5f5f5;
  padding: 10px;
  white-space: pre-wrap;
}
.box {
  border: 1px solid #ccc;
  padding: 10px;
  margin-top: 10px;
}
#reader {
  width: 100%;
}
</style>
</head>
<body>

<h2>Solana QR Balance & Transaction Tool</h2>

<label>Network</label>
<select id="network">
  <option value="mainnet-beta">Mainnet</option>
  <option value="devnet">Devnet</option>
  <option value="testnet">Testnet</option>
</select>

<div class="box">
  <strong>Scan Private Key QR</strong>
  <div id="reader"></div>
</div>

<label>Private Key (Base64)</label>
<input id="privkey">

<button onclick="loadAccount()">Load Account</button>

<pre id="info">(no account loaded)</pre>

<hr>

<h3>Send SOL</h3>

<button onclick="scanRecipient()">Scan Recipient QR</button>

<label>Recipient Address</label>
<input id="to">

<label>Amount (SOL)</label>
<input id="amount" type="number" step="0.000001">

<button onclick="sendSol()">Send Transaction</button>

<pre id="txlog"></pre>

<script>
let connection;
let keypair;
let scanner;

// ---- Explicit RPC endpoints (NO WebSockets) ----
const RPC_ENDPOINTS = {
  "mainnet-beta": "https://api.mainnet-beta.solana.com",
  "devnet": "https://api.devnet.solana.com",
  "testnet": "https://api.testnet.solana.com"
};

function getConnection() {
  const net = document.getElementById('network').value;
  return new solanaWeb3.Connection(
    RPC_ENDPOINTS[net],
    {
      commitment: "confirmed",
      wsEndpoint: null // ðŸš¨ disable WebSockets
    }
  );
}

// ---- QR Scanner (lazy start) ----
scanner = new Html5Qrcode("reader");

function scanPrivateKey() {
  scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 200 },
    text => {
      document.getElementById('privkey').value = text;
      scanner.stop();
    }
  );
}

// ---- Account loading ----
function loadAccount() {
  try {
    const priv = document.getElementById('privkey').value.trim();
    const bytes = Uint8Array.from(atob(priv), c => c.charCodeAt(0));

    keypair = solanaWeb3.Keypair.fromSecretKey(bytes);
    connection = getConnection();

    refreshInfo();
  } catch (e) {
    alert("Invalid private key");
  }
}

async function refreshInfo() {
  const pub = keypair.publicKey;

  const balance = await connection.getBalance(pub);
  const info = await connection.getAccountInfo(pub);

  document.getElementById('info').textContent =
`Address:
${pub.toBase58()}

Balance:
${balance / solanaWeb3.LAMPORTS_PER_SOL} SOL

Owner:
${info?.owner.toBase58() || "N/A"}

Executable:
${info?.executable || false}`;
}

// ---- Recipient QR ----
function scanRecipient() {
  scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 200 },
    text => {
      document.getElementById('to').value = text;
      scanner.stop();
    }
  );
}

// ---- Send SOL ----
async function sendSol() {
  try {
    const to = new solanaWeb3.PublicKey(
      document.getElementById('to').value.trim()
    );

    const amount =
      parseFloat(document.getElementById('amount').value) *
      solanaWeb3.LAMPORTS_PER_SOL;

    const tx = new solanaWeb3.Transaction().add(
      solanaWeb3.SystemProgram.transfer({
        fromPubkey: keypair.publicKey,
        toPubkey: to,
        lamports: amount
      })
    );

    const sig = await solanaWeb3.sendAndConfirmTransaction(
      connection,
      tx,
      [keypair]
    );

    document.getElementById('txlog').textContent =
      `Transaction sent:\n${sig}`;

    refreshInfo();
  } catch (e) {
    document.getElementById('txlog').textContent =
      `Error:\n${e.message}`;
  }
}
</script>


</body>
</html>
